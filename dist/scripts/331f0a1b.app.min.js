"use strict";var myApp=angular.module("RostRecept",["ngAnimate","ngRoute"]).constant("version","v0.1.0").config(["$locationProvider","$routeProvider",function(a,b){a.html5Mode(!1),b.when("/",{templateUrl:"views/home.html"}).otherwise({redirectTo:"/"})}]);myApp.config(["$httpProvider",function(a){a.defaults.useXDomain=!0}]),angular.module("RostRecept").controller("MainCtrl",["$scope","$location","version",function(a,b,c){a.$path=b.path.bind(b),a.version=c}]),angular.module("RostRecept").controller("voteCtrl",["$scope","voteService","votingresultService","forslagParser",function(a,b,c,d){function e(a){var d=a.voteringid;return b.fetchVoteResult(a.votering_url_xml).then(function(a){c.addGovermentVote(d,a)}),a}function f(b){return b.inverted=Math.random()<.5,a.next.vote=b,b}function g(a){var c=d.parse(a.forslag);a.parsedForslag=[],c.forEach(function(c){b.fetchTextForMotion(c.dokumentCode,c.yrkande,c.avslag).then(function(b){b.forEach(function(b){var c="";!b.avslag!=!a.inverted&&(c="inte "),b.summary=b.summary.replace("Riksdagen tillkännager för regeringen som sin mening vad som anförs i motionen om att ","Jag anser "+c+" att "),b.summary=b.summary.replace("Riksdagen tillkännager för regeringen som sin mening vad som anförs i motionen om","Vi borde "+c+"se över "),b.summary=b.summary.replace("Riksdagen tillkännager för regeringen som sin mening vad som anförs i motionen om möjlighete","Låt oss "+c+"överväga möjlighete"),a.parsedForslag.push(b)})})})}function h(){return void 0!=a.next.vote&&(a.vote=a.next.vote),b.fetchVote().then(f).then(e).then(g)}function i(b){var d=a.vote.voteringid;return c.addUserVote({id:d,result:b}),a.voteringinformation=c.resultOfVote(d),null==a.voteringinformation?(console.log("It happened"),a.totalResult=c.totalResult(),void h()):(a.voteringinformation.summary=a.vote.summary,a.voteringinformation.titel=a.vote.titel,a.totalResult=c.totalResult(),void h())}a.next={},a.searchText="",b.init().then(function(){h().then(h)}),a.agreeWithVote=function(){i(a.vote.inverted?"Nej":"Ja")},a.disagreeWithVote=function(){i(a.vote.inverted?"Ja":"Nej")}}]);var riksdagensapi=angular.module("RostRecept");riksdagensapi.factory("voteService",["$http","$q",function(a,b){function c(b){return a.jsonp(k+"dokumentlista/?rm="+b.rm+"&bet="+b.bet+"&utformat=jsonp&callback=JSON_CALLBACK").then(function(a){return a.data.dokumentlista.dokument})}function d(c,d){var e=b.defer(),f=c.dokumentstatus_url_xml.replace(".xml",".jsonp?callback=JSON_CALLBACK"),h=f.replace("dokumentstatus","utskottsforslag");return a.jsonp(h).success(function(a){g(a)}),g=function(a){var b=[],c=a.utskottsforslag.dokutskottsforslag.utskottsforslag;if(Array.isArray(c))var b=c.filter(function(a){return a.punkt==d.punkt});else b.push(c);b[0].titel=a.utskottsforslag.dokument.titel,e.resolve(b[0])},e.promise}function e(a){a.cleanforslag=a.forslag.replace(/av [^\)]*\)\s?/g,"").replace(/\s,\s/g,", ")}function f(b,c){return a.jsonp("http://data.riksdagen.se/voteringlista/?rm="+b+"&sz=5&utformat=jsonp&gruppering=bet&callback=JSON_CALLBACK").success(function(a){return a.voteringlista.votering.forEach(function(a){c.votering.push(a)}),a.voteringlista})}var g,h,i,j=[],k="http://data.riksdagen.se/",l={};return window.rdjsonp=function(a){if(void 0!=a.votering&&h(a),void 0!=a.utskottsforslag&&g(a),void 0!=a.dokumentstatus){var b=a.dokumentstatus.dokument.dok_id,c=l[b];c||console.warn(c+" promise for dokid "+b+" was undefined"),i(a,c.promise,c.avslag),delete l[b]}},{years:["2013%2F14"],votering:j,init:function(){var a=[],c=this;return this.years.forEach(function(b){var d=f(b,c);a.push(d)}),b.all(a)},fetchVote:function(){var a=j.splice(Math.floor(Math.random()*this.votering.length),1)[0];return c(a).then(function(b){return d(b,a)}).then(function(b){return e(b),{titel:b.titel,summary:b.rubrik,forslag:b.cleanforslag,forslagurl:b.cleanCodes,voteringid:b.votering_id,votering_url_xml:b.votering_url_xml,orginalvotering:a.forslagspunkt}})},fetchVoteResult:function(c){var d=b.defer(),e=c+".jsonp";return a.jsonp(e).success(function(a){h(a)}),h=function(a){var b=a.votering.dokvotering.votering;b.forEach(function(a){a.randomNumber=Math.random()}),d.resolve(b)},d.promise},fetchTextForMotion:function(c,d,e){var f=b.defer();if(null==c)return void console.warn(c+d+e);var g=k+"dokumentstatus/"+c+".jsonp";return a.jsonp(g).success(function(a){i(a,f,e)}),i=function(a,b,e){null==a.dokumentstatus.dokforslag&&b.fail();var f=a.dokumentstatus.dokforslag.forslag;if(Array.isArray(f)){var g=[];null!=d&&(f=f.filter(function(a){return d.indexOf(a.nummer)>-1})),f.forEach(function(a){g.push({dokumentCode:c,yrkande:a.nummer,summary:a.lydelse,avslag:e})}),b.resolve(g)}else b.resolve([{dokumentCode:c,yrkande:f.nummer,summary:f.lydelse+(f.lydelse2||" "),avslag:e}])},l[c]={promise:f,avslag:e},f.promise}}}]),angular.module("RostRecept").factory("votingresultService",[function(){var a={},b={},c={};return{userVotes:a,govermentVotes:b,addUserVote:function(b){a[b.id]=b},addGovermentVote:function(a,c){b[a]=c},resultOfVote:function(d){var e=a[d],f=b[d];if(null!=f){var g=f.filter(function(a){var b;return null==c[a.intressent_id]&&(c[a.intressent_id]={namn:a.namn,intressent_id:a.intressent_id,parti:a.parti,valkrets:a.valkrets,score:0}),b=c[a.intressent_id],a.rost==e.result?(b.score++,!0):void 0});return g}},totalResult:function(){return _.values(c)}}}]),angular.module("RostRecept").factory("forslagParser",[function(){function a(a){return a=a.match(/[A-Za-z]/)?a.replace(":","02"):a.replace(":","03"),a=a.replace(/2011\/12/g,"GZ"),a=a.replace(/2012\/13/g,"H0"),a=a.replace(/2013\/14/g,"H1")}return{convert:a,parse:function(b){var c=[],d=!1,e="",f=[],g=!1,h=b.split(/[\s,\.]/g);return h.forEach(function(b){if("avslår"==b&&(""!=e&&(c.push({dokumentCode:e,yrkande:f,avslag:d}),e="",f=[]),d=!0),b.match(/201\d\/\d\d:\S*/)&&(""!=e&&c.push({dokumentCode:e,yrkande:f,avslag:d}),g=!1,f=[],e=a(b)),(b.match(/yrkande/)||b.match(/punkt/))&&(g=!0),g&&b.match(/[\d-]+/g)){var h=b.indexOf("–");if(h>-1)for(var i=Number(b.substring(0,h)),j=Number(b.substring(h+1));j>=i;)f.push(i+""),i++;0>h&&f.push(b)}}),c.push({dokumentCode:e,yrkande:f,avslag:d}),c}}}]);